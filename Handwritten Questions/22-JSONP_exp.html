<!--
 * @Author: FelicityğŸ’ª
 * @Date: 2023-08-24 16:40:12
 * @LastEditTime: 2023-08-24 20:47:08
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>

</body>

</html>

<script>
  // (function (window, document) {
  //   "use strict";
  //   var jsonp = function (url, data, callback) {

  //     // 1.å°†ä¼ å…¥çš„dataæ•°æ®è½¬åŒ–ä¸ºurlå­—ç¬¦ä¸²å½¢å¼
  //     // {id:1,name:'jack'} => id=1&name=jack
  //     var dataString = url.indexof('?') == -1 ? '?' : '&';
  //     for (var key in data) {
  //       dataString += key + '=' + data[key] + '&';
  //     };

  //     // 2 å¤„ç†urlä¸­çš„å›è°ƒå‡½æ•°
  //     // cbFuncNameå›è°ƒå‡½æ•°çš„åå­— ï¼šmy_json_cb_åå­—çš„å‰ç¼€ + éšæœºæ•°ï¼ˆæŠŠå°æ•°ç‚¹å»æ‰ï¼‰
  //     var cbFuncName = 'my_json_cb_' + Math.random().toString().replace('.', '');
  //     dataString += 'callback=' + cbFuncName;

  //     // 3.åˆ›å»ºä¸€ä¸ªscriptæ ‡ç­¾å¹¶æ’å…¥åˆ°é¡µé¢ä¸­
  //     var scriptEle = document.createElement('script');
  //     scriptEle.src = url + dataString;

  //     // 4.æŒ‚è½½å›è°ƒå‡½æ•°
  //     window[cbFuncName] = function (data) {
  //       callback(data);
  //       // å¤„ç†å®Œå›è°ƒå‡½æ•°çš„æ•°æ®ä¹‹åï¼Œåˆ é™¤jsonpçš„scriptæ ‡ç­¾
  //       document.body.removeChild(scriptEle);
  //     }

  //     document.body.appendChild(scriptEle);
  //   }

  //   window.$jsonp = jsonp;

  // })(window, document)

  (function (global) {
    var id = 0,
      container = document.getElementsByTagName("head")[0];

    function jsonp(options) {
      if (!options || !options.url) return;

      var scriptNode = document.createElement("script"),
        data = options.data || {},
        url = options.url,
        callback = options.callback,
        fnName = "jsonp" + id++;

      // æ·»åŠ å›è°ƒå‡½æ•°
      data["callback"] = fnName;

      // æ‹¼æ¥url
      var params = [];
      for (var key in data) {
        params.push(encodeURIComponent(key) + "=" + encodeURIComponent(data[key]));
      }
      url = url.indexOf("?") > 0 ? (url + "&") : (url + "?");
      url += params.join("&");
      scriptNode.src = url;

      // ä¼ é€’çš„æ˜¯ä¸€ä¸ªåŒ¿åçš„å›è°ƒå‡½æ•°ï¼Œè¦æ‰§è¡Œçš„è¯ï¼Œæš´éœ²ä¸ºä¸€ä¸ªå…¨å±€æ–¹æ³•
      global[fnName] = function (ret) {
        callback && callback(ret);
        container.removeChild(scriptNode);
        delete global[fnName];
      }

      // å‡ºé”™å¤„ç†
      scriptNode.onerror = function () {
        callback && callback({ error: "error" });
        container.removeChild(scriptNode);
        global[fnName] && delete global[fnName];
      }

      scriptNode.type = "text/javascript";
      container.appendChild(scriptNode)
    }

    global.jsonp = jsonp;

  })(this);

  jsonp({
    url: "www.example.com",
    data: { id: 1 },
    callback: function (ret) {
      console.log(ret);
    }
  });

</script>